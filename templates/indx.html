<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarketPulse AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0f0f1e; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
    .card { background: #1a1a2e; border: 1px solid #333; border-radius: 12px; transition: 0.3s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,255,136,0.1); }
    .signal { font-weight: bold; }
    .badge-success { background: #00ff88 !important; color: black; }
    .badge-danger { background: #ff0066 !important; color: white; }
    .badge-warning { background: #ffaa00 !important; color: black; }
    .chart-container { height: 60px; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="text-center mb-4">
      <h1 class="display-5 text-success pulse">MarketPulse AI</h1>
      <p>Real-time ML-powered market signals • Auto-refreshes every 5 min</p>
      <small id="last-updated" class="text-muted">Loading...</small>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="cards"></div>

    <div class="text-center mt-5">
      <small class="text-muted">Not financial advice • For educational use</small>
    </div>
  </div>

  <script>
    const colors = {
      success: ['#00ff88', '#00cc66'],
      danger: ['#ff0066', '#cc0052'],
      warning: ['#ffaa00', '#cc8800']
    };

    function createChart(ctx, prob, colorKey) {
      const gradient = ctx.createLinearGradient(0, 0, 0, 60);
      const col = colors[colorKey] || colors.warning;
      gradient.addColorStop(0, col[0]);
      gradient.addColorStop(1, col[1]);
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [prob*100, (1-prob)*100],
            backgroundColor: [gradient, '#333'],
            borderWidth: 0
          }]
        },
        options: { cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
      });
    }

    async function loadData() {
      const res = await fetch('/api/data');
      const json = await res.json();
      const data = json.data;
      document.getElementById('last-updated').innerText = `Updated: ${new Date(json.time).toLocaleTimeString()}`;

      const container = document.getElementById('cards');
      container.innerHTML = '';

      data.forEach(item => {
        if (item.error) {
          container.innerHTML += `<div class="col"><div class="card h-100 p-3"><h5>${item.ticker}</h5><p class="text-danger">Error</p></div></div>`;
          return;
        }

        const card = document.createElement('div');
        card.className = 'col';
        card.innerHTML = `
          <div class="card h-100 p-3 text-white">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="mb-0">${item.ticker}</h5>
              <span class="badge badge-${item.color} signal">${item.signal}</span>
            </div>
            <div class="text-success fs-4 fw-bold">$${item.price}</div>
            <div class="chart-container position-relative mb-3">
              <canvas></canvas>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="fs-5">${(item.prob_up*100).toFixed(0)}%</div>
              </div>
            </div>
            <div class="row text-center g-2 small">
              <div class="col">
                <div>Score</div>
                <div class="text-info">${item.composite > 0 ? '+' : ''}${item.composite}</div>
              </div>
              <div class="col">
                <div>10Y Return</div>
                <div class="${item.return > 0 ? 'text-success' : 'text-danger'}">${(item.return*100).toFixed(1)}%</div>
              </div>
              <div class="col">
                <div>Accuracy</div>
                <div class="text-warning">${(item.accuracy*100).toFixed(0)}%</div>
              </div>
            </div>
            <small class="text-muted d-block text-end mt-2">Updated ${item.updated}</small>
          </div>
        `;
        container.appendChild(card);

        const canvas = card.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        createChart(ctx, item.prob_up, item.color);
      });
    }

    loadData();
    setInterval(loadData, 300000); // 5 min
  </script>
</body>
</html>